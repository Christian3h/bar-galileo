{% extends 'base_admin.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/main/admin/nominas.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container empleado-perfil-page">
    <h2 class="dashboard-title">Perfil del Empleado</h2>
    <div class="buttons-group buttons-group-detail">
        <a href="{% url 'nominas:empleado_list' %}" class="btn btn-secondary" title="Volver a la lista de empleados">
            <i class="fa fa-arrow-left"></i> Volver
        </a>
        <a href="{% url 'nominas:empleado_editar' empleado.pk %}" class="btn btn-primary" title="Editar información del empleado">
            <i class="fa fa-edit"></i> Editar
        </a>
    </div>

    <div class="perfil-grid">
        <!-- Columna izquierda: Datos + Contacto -->
        <div class="perfil-col">
            <section class="perfil-panel">
                <h3>Datos Personales</h3>
                <div class="perfil-identidad">
                    <div class="perfil-nombre">{{ empleado.nombre }}</div>
                    <div class="perfil-cargo badge">{{ empleado.cargo }}</div>
                </div>
                <ul class="perfil-datos">
                    <li>
                        <span class="label">Estado:</span>
                        <span class="value badge {% if empleado.estado == 'activo' %}bg-success{% elif empleado.estado == 'inactivo' %}bg-danger{% elif empleado.estado == 'vacaciones' %}bg-info{% elif empleado.estado == 'permiso' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ empleado.get_estado_display }}
                        </span>
                    </li>
                    <li>
                        <span class="label">Tipo de Contrato:</span>
                        <span class="value">{{ empleado.get_tipo_contrato_display }}</span>
                    </li>
                    <li>
                        <span class="label">Salario Base:</span>
                        <strong class="value">${{ empleado.salario }}</strong>
                    </li>
                    <li>
                        <span class="label">Fecha de Contratación:</span>
                        <span class="value">{{ empleado.fecha_contratacion }}</span>
                    </li>
                    <li>
                        <span class="label">Antigüedad:</span>
                        <span class="value">{{ empleado.antiguedad }} años</span>
                    </li>
                </ul>
            </section>

            {% if empleado.user %}
            <section class="perfil-panel">
                <h3>Acceso al Sistema</h3>
                <ul class="perfil-datos">
                    <li>
                        <span class="label">Usuario:</span>
                        <span class="value">
                            <span class="badge bg-primary">
                                <i class="fa fa-user"></i> {{ empleado.user.username }}
                            </span>
                        </span>
                    </li>
                    <li>
                        <span class="label">Email de acceso:</span>
                        <span class="value">{{ empleado.user.email }}</span>
                    </li>
                    <li>
                        <span class="label">Estado de cuenta:</span>
                        <span class="value">
                            {% if empleado.user.is_active %}
                                <span class="badge bg-success">Activo</span>
                            {% else %}
                                <span class="badge bg-danger">Inactivo</span>
                            {% endif %}
                        </span>
                    </li>
                    <li>
                        <span class="label">Último acceso:</span>
                        <span class="value">
                            {% if empleado.user.last_login %}
                                {{ empleado.user.last_login|date:"d/m/Y H:i" }}
                            {% else %}
                                <span class="text-muted">Nunca</span>
                            {% endif %}
                        </span>
                    </li>
                    {% if empleado.user.userprofile.rol %}
                    <li>
                        <span class="label">Rol:</span>
                        <span class="value">
                            <span class="badge bg-info">{{ empleado.user.userprofile.rol.nombre }}</span>
                        </span>
                    </li>
                    {% endif %}
                </ul>
            </section>
            {% else %}
            <section class="perfil-panel">
                <h3>Acceso al Sistema</h3>
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle"></i>
                    Este empleado no tiene usuario vinculado al sistema.
                    <br>
                    <a href="{% url 'nominas:empleado_editar' empleado.pk %}" class="btn btn-sm btn-primary mt-2">
                        <i class="fa fa-user-plus"></i> Vincular Usuario
                    </a>
                </div>
            </section>
            {% endif %}

            {% if empleado.email or empleado.telefono or empleado.direccion %}
            <section class="perfil-panel">
                <h3>Información de Contacto</h3>
                <ul class="perfil-datos">
                    {% if empleado.email %}
                    <li>
                        <span class="label">Email:</span>
                        <span class="value">{{ empleado.email }}</span>
                    </li>
                    {% endif %}
                    {% if empleado.telefono %}
                    <li>
                        <span class="label">Teléfono:</span>
                        <span class="value">{{ empleado.telefono }}</span>
                    </li>
                    {% endif %}
                    {% if empleado.direccion %}
                    <li>
                        <span class="label">Dirección:</span>
                        <span class="value">{{ empleado.direccion }}</span>
                    </li>
                    {% endif %}
                </ul>
            </section>
            {% endif %}
        </div>

        <!-- Columna derecha: Pagos + Bonificaciones -->
        <div class="perfil-col">
            <section class="perfil-panel">
                <div class="panel-header">
                    <h3>Historial de Pagos</h3>
                    <a href="{% url 'nominas:agregar_pago' empleado.id %}" class="btn btn-primary btn-sm" title="Registrar un nuevo pago">
                        <i class="fa fa-plus"></i> Registrar Pago
                    </a>
                </div>

                <div class="info-row-box">
                    <span class="info-label">Total Pagado</span>
                    <span class="info-value">${{ total_pagado }}</span>
                </div>

                <div class="table-responsive">
                    <table id="tabla-pagos" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Monto</th>
                                <th class="descripcionCol">Descripción</th>
                                <th class="comprobanteCol" {% if not pagos %}style="display: none;"{% endif %}>Comprobante</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pago in pagos %}
                            <tr>
                                <td>{{ pago.fecha_pago }}</td>
                                <td>{{ pago.get_tipo_display }}</td>
                                <td>${{ pago.monto }}</td>
                                <td class="descripcionCol">{{ pago.descripcion|default:"-" }}</td>
                                <td class="comprobanteCol">
                                    {% if pago.comprobante %}
                                        <button type="button" class="btn btn-sm btn-secondary preview-comprobante"
                                                data-url="{{ pago.comprobante.url }}"
                                                data-name="{{ pago.comprobante.name }}"
                                                title="Ver comprobante de pago">
                                            <i class="fa fa-eye"></i> Ver
                                        </button>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center" style="color: var(--color-secondary);">No hay pagos registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="perfil-panel">
                <div class="panel-header">
                    <h3>Bonificaciones</h3>
                    <a href="{% url 'nominas:agregar_bonificacion' empleado.id %}" class="btn btn-primary btn-sm" title="Agregar una nueva bonificación">
                        <i class="fa fa-plus"></i> Agregar Bonificación
                    </a>
                </div>

                <div class="table-responsive">
                    <table id="tabla-bonificaciones" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Monto</th>
                                <th>Recurrente</th>
                                <th class="fechaInicioCol">Inicio</th>
                                <th class="fechaFinCol">Fin</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bonificacion in bonificaciones %}
                            <tr>
                                <td>{{ bonificacion.nombre }}</td>
                                <td>${{ bonificacion.monto }}</td>
                                <td>
                                    {% if bonificacion.recurrente %}
                                        <span class="badge bg-success">Sí</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td class="fechaInicioCol">{{ bonificacion.fecha_inicio }}</td>
                                <td class="fechaFinCol">{{ bonificacion.fecha_fin|default:"-" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center" style="color: var(--color-secondary);">No hay bonificaciones registradas</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Modal para preview de comprobantes -->
<div id="comprobanteModal" class="modal-preview" style="display: none;">
    <div class="modal-preview-content">
        <span class="close-modal-preview">&times;</span>
        <h3 id="comprobanteModalTitle" style="color: var(--color-secondary); margin-bottom: 1rem;">Comprobante de Pago</h3>
        <div id="comprobanteModalBody" style="text-align: center;">
            <!-- Contenido dinámico -->
        </div>
        <div style="margin-top: 1rem; text-align: center;">
            <a id="comprobanteDownloadLink" href="#" target="_blank" class="btn btn-primary" download>
                <i class="fa fa-download"></i> Descargar
            </a>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<style>
/* Modal para preview de archivos */
.modal-preview {
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.8);
}

.modal-preview-content {
    background-color: #2c2c2c;
    margin: 5% auto;
    padding: 2rem;
    border: 2px solid var(--color-secondary);
    border-radius: 12px;
    width: 80%;
    max-width: 800px;
    box-shadow: 0 4px 20px rgba(166, 137, 50, 0.4);
}

.close-modal-preview {
    color: var(--color-secondary);
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close-modal-preview:hover,
.close-modal-preview:focus {
    color: var(--color-primary);
}

.modal-preview img {
    max-width: 100%;
    max-height: 500px;
    border-radius: 8px;
    border: 2px solid var(--color-secondary);
}

.modal-preview embed,
.modal-preview iframe {
    width: 100%;
    height: 500px;
    border: 2px solid var(--color-secondary);
    border-radius: 8px;
}

.file-icon {
    font-size: 100px;
    color: var(--color-secondary);
    margin: 2rem 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar DataTable para Historial de Pagos
    var tablaPagos = '#tabla-pagos';
    if ($(tablaPagos).length) {
        var hasPagos = $(tablaPagos + ' tbody tr').length > 0 && !$(tablaPagos + ' tbody tr td[colspan]').length;
        if (hasPagos) {
            if ($.fn.dataTable.isDataTable(tablaPagos)) {
                $(tablaPagos).DataTable().destroy();
            }
            $(tablaPagos).DataTable({
                language: {
                    url: "{% static 'js/DataTables/es-ES.json' %}"
                },
                columnDefs: [
                    { targets: '_all', defaultContent: '' },
                    { targets: [3], className: 'descripcionCol' },
                    { targets: [4], className: 'comprobanteCol' }
                ],
                responsive: true,
                pageLength: 10,
                lengthChange: true,
                ordering: true,
                order: [[0, 'desc']]
            });
        }
    }

    // Inicializar DataTable para Bonificaciones
    var tablaBonificaciones = '#tabla-bonificaciones';
    if ($(tablaBonificaciones).length) {
        var hasBonificaciones = $(tablaBonificaciones + ' tbody tr').length > 0 && !$(tablaBonificaciones + ' tbody tr td[colspan]').length;
        if (hasBonificaciones) {
            if ($.fn.dataTable.isDataTable(tablaBonificaciones)) {
                $(tablaBonificaciones).DataTable().destroy();
            }
            $(tablaBonificaciones).DataTable({
                language: {
                    url: "{% static 'js/DataTables/es-ES.json' %}"
                },
                columnDefs: [
                    { targets: '_all', defaultContent: '' },
                    { targets: [3], className: 'fechaInicioCol' },
                    { targets: [4], className: 'fechaFinCol' }
                ],
                responsive: true,
                pageLength: 10,
                lengthChange: true,
                ordering: true,
                order: [[0, 'asc']]
            });
        }
    }

    // Modal de preview de comprobantes
    const modal = document.getElementById('comprobanteModal');
    const modalBody = document.getElementById('comprobanteModalBody');
    const modalTitle = document.getElementById('comprobanteModalTitle');
    const downloadLink = document.getElementById('comprobanteDownloadLink');
    const closeBtn = document.querySelector('.close-modal-preview');

    // Botones de preview
    document.querySelectorAll('.preview-comprobante').forEach(button => {
        button.addEventListener('click', function() {
            const url = this.dataset.url;
            const name = this.dataset.name;
            const extension = url.split('.').pop().toLowerCase();

            modalTitle.textContent = 'Comprobante de Pago';
            downloadLink.href = url;
            downloadLink.download = name || 'comprobante';

            // Limpiar contenido previo
            modalBody.innerHTML = '';

            // Mostrar según el tipo de archivo
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension)) {
                // Es una imagen
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Comprobante';
                modalBody.appendChild(img);
            } else if (extension === 'pdf') {
                // Es un PDF
                const embed = document.createElement('embed');
                embed.src = url;
                embed.type = 'application/pdf';
                modalBody.appendChild(embed);
            } else {
                // Otro tipo de archivo
                const icon = document.createElement('div');
                icon.className = 'file-icon';
                icon.innerHTML = '<i class="fa fa-file"></i>';
                modalBody.appendChild(icon);

                const text = document.createElement('p');
                text.style.color = 'var(--color-secondary)';
                text.textContent = 'Vista previa no disponible para este tipo de archivo';
                modalBody.appendChild(text);
            }

            modal.style.display = 'block';
        });
    });

    // Cerrar modal
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
});
</script>
{% endblock %}