{% extends 'base_admin.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/main/admin/nominas.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container empleado-perfil-page">
    <h2 class="dashboard-title">Perfil del Empleado</h2>
    <div class="buttons-group buttons-group-detail">
        <a href="{% url 'nominas:empleado_list' %}" class="btn btn-secondary" title="Volver a la lista de empleados">
            <i class="fa fa-arrow-left"></i> Volver
        </a>
        <a href="{% url 'nominas:empleado_editar' empleado.pk %}" class="btn btn-primary" title="Editar información del empleado">
            <i class="fa fa-edit"></i> Editar
        </a>
    </div>

    <div class="perfil-grid">
        <!-- Columna izquierda: Datos + Contacto -->
        <div class="perfil-col">
            <section class="perfil-panel">
                <h3>Datos Personales</h3>
                <div class="perfil-identidad">
                    <div class="perfil-nombre">{{ empleado.nombre }}</div>
                    <div class="perfil-cargo badge">{{ empleado.cargo }}</div>
                </div>
                <ul class="perfil-datos">
                    <li>
                        <span class="label">Estado:</span>
                        <span class="value badge {% if empleado.estado == 'activo' %}bg-success{% elif empleado.estado == 'inactivo' %}bg-danger{% elif empleado.estado == 'vacaciones' %}bg-info{% elif empleado.estado == 'permiso' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ empleado.get_estado_display }}
                        </span>
                    </li>
                    <li>
                        <span class="label">Tipo de Contrato:</span>
                        <span class="value">{{ empleado.get_tipo_contrato_display }}</span>
                    </li>
                    <li>
                        <span class="label">Salario Base:</span>
                        <strong class="value">${{ empleado.salario }}</strong>
                    </li>
                    <li>
                        <span class="label">Fecha de Contratación:</span>
                        <span class="value">{{ empleado.fecha_contratacion }}</span>
                    </li>
                    <li>
                        <span class="label">Antigüedad:</span>
                        <span class="value">{{ empleado.antiguedad }} años</span>
                    </li>
                </ul>
            </section>

            {% if empleado.user %}
            <section class="perfil-panel">
                <h3>Acceso al Sistema</h3>
                <ul class="perfil-datos">
                    <li>
                        <span class="label">Usuario:</span>
                        <span class="value">
                            <span class="badge bg-primary">
                                <i class="fa fa-user"></i> {{ empleado.user.username }}
                            </span>
                        </span>
                    </li>
                    <li>
                        <span class="label">Email de acceso:</span>
                        <span class="value">{{ empleado.user.email }}</span>
                    </li>
                    <li>
                        <span class="label">Estado de cuenta:</span>
                        <span class="value">
                            {% if empleado.user.is_active %}
                                <span class="badge bg-success">Activo</span>
                            {% else %}
                                <span class="badge bg-danger">Inactivo</span>
                            {% endif %}
                        </span>
                    </li>
                    <li>
                        <span class="label">Último acceso:</span>
                        <span class="value">
                            {% if empleado.user.last_login %}
                                {{ empleado.user.last_login|date:"d/m/Y H:i" }}
                            {% else %}
                                <span class="text-muted">Nunca</span>
                            {% endif %}
                        </span>
                    </li>
                    {% if empleado.user.userprofile.rol %}
                    <li>
                        <span class="label">Rol:</span>
                        <span class="value">
                            <span class="badge bg-info">{{ empleado.user.userprofile.rol.nombre }}</span>
                        </span>
                    </li>
                    {% endif %}
                </ul>
            </section>
            {% else %}
            <section class="perfil-panel">
                <h3>Acceso al Sistema</h3>
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle"></i>
                    Este empleado no tiene usuario vinculado al sistema.
                    <br>
                    <a href="{% url 'nominas:empleado_editar' empleado.pk %}" class="btn btn-sm btn-primary mt-2">
                        <i class="fa fa-user-plus"></i> Vincular Usuario
                    </a>
                </div>
            </section>
            {% endif %}

            {% if empleado.email or empleado.telefono or empleado.direccion %}
            <section class="perfil-panel">
                <h3>Información de Contacto</h3>
                <ul class="perfil-datos">
                    {% if empleado.email %}
                    <li>
                        <span class="label">Email:</span>
                        <span class="value">{{ empleado.email }}</span>
                    </li>
                    {% endif %}
                    {% if empleado.telefono %}
                    <li>
                        <span class="label">Teléfono:</span>
                        <span class="value">{{ empleado.telefono }}</span>
                    </li>
                    {% endif %}
                    {% if empleado.direccion %}
                    <li>
                        <span class="label">Dirección:</span>
                        <span class="value">{{ empleado.direccion }}</span>
                    </li>
                    {% endif %}
                </ul>
            </section>
            {% endif %}
        </div>

        <!-- Columna derecha: Pagos + Bonificaciones -->
        <div class="perfil-col">
            <section class="perfil-panel">
                <div class="panel-header">
                    <h3>Historial de Pagos</h3>
                    <a href="{% url 'nominas:agregar_pago' empleado.id %}" class="btn btn-primary btn-sm" title="Registrar un nuevo pago">
                        <i class="fa fa-plus"></i> Registrar Pago
                    </a>
                </div>

                <div class="info-row-box">
                    <span class="info-label">Total Pagado</span>
                    <span class="info-value">${{ total_pagado }}</span>
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Monto</th>
                                <th class="descripcionCol">Descripción</th>
                                <th class="comprobanteCol">Comprobante</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pago in pagos %}
                            <tr>
                                <td>{{ pago.fecha_pago }}</td>
                                <td>{{ pago.get_tipo_display }}</td>
                                <td>${{ pago.monto }}</td>
                                <td class="descripcionCol">{{ pago.descripcion|default:"-" }}</td>
                                <td class="comprobanteCol">
                                    {% if pago.comprobante %}
                                        <a href="{{ pago.comprobante.url }}" target="_blank" class="btn btn-sm btn-secondary" title="Descargar comprobante de pago">
                                            <i class="fa fa-download"></i>
                                        </a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No hay pagos registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="perfil-panel">
                <div class="panel-header">
                    <h3>Bonificaciones</h3>
                    <a href="{% url 'nominas:agregar_bonificacion' empleado.id %}" class="btn btn-primary btn-sm" title="Agregar una nueva bonificación">
                        <i class="fa fa-plus"></i> Agregar Bonificación
                    </a>
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Monto</th>
                                <th>Recurrente</th>
                                <th>Inicio</th>
                                <th>Fin</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bonificacion in bonificaciones %}
                            <tr>
                                <td>{{ bonificacion.nombre }}</td>
                                <td>${{ bonificacion.monto }}</td>
                                <td>
                                    {% if bonificacion.recurrente %}
                                        <span class="badge bg-success">Sí</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>{{ bonificacion.fecha_inicio }}</td>
                                <td>{{ bonificacion.fecha_fin|default:"-" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No hay bonificaciones registradas</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}