{% extends 'base_admin.html' %}
{% load static %}
{% load roles_tags %}

{% block extra_css %}
  <style>
    .detail-card {
      background: var(--card-bg, #262626);
      border: 1px solid var(--border-color, #444);
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 20px;
    }
    
    .detail-header {
      border-bottom: 2px solid var(--primary-color, #d4af37);
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    
    .detail-header h2 {
      color: var(--primary-color, #d4af37);
      margin: 0;
    }
    
    .detail-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .detail-item {
      padding: 10px 0;
    }
    
    .detail-item label {
      display: block;
      color: var(--primary-color, #d4af37);
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.9rem;
      text-transform: uppercase;
    }
    
    .detail-item .value {
      color: var(--text-color, #fff);
      font-size: 1rem;
    }
    
    .tipo-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .badge-ventas { background-color: #27ae60; color: white; }
    .badge-inventario { background-color: #3498db; color: white; }
    .badge-gastos { background-color: #e74c3c; color: white; }
    .badge-nominas { background-color: #9b59b6; color: white; }
    .badge-general { background-color: #95a5a6; color: white; }
    
    .description-box {
      background: var(--input-bg, #1a1a1a);
      border: 1px solid var(--border-color, #444);
      border-radius: 6px;
      padding: 15px;
      margin-top: 10px;
      line-height: 1.6;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .detail-row {
        grid-template-columns: 1fr;
      }
      .action-buttons {
        flex-direction: column;
      }
      .action-buttons .btn {
        width: 100%;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="my-4">Detalle del Reporte</h2>
    
    <div class="detail-card">
        <div class="detail-header">
            <h2>{{ reporte.nombre }}</h2>
        </div>
        
        <div class="detail-row">
            <div class="detail-item">
                <label>Tipo de Reporte</label>
                <div class="value">
                    <span class="tipo-badge badge-{{ reporte.tipo }}">
                        {{ reporte.get_tipo_display }}
                    </span>
                </div>
            </div>
            
            <div class="detail-item">
                <label>Periodo</label>
                <div class="value">
                    <span class="badge bg-info">{{ reporte.get_periodo_display }}</span>
                </div>
            </div>
            
            <div class="detail-item">
                <label>Formato</label>
                <div class="value">
                    <span class="badge bg-secondary">{{ reporte.get_formato_display|upper }}</span>
                </div>
            </div>
        </div>
        
        <div class="detail-row">
            <div class="detail-item">
                <label>Creado por</label>
                <div class="value">{{ reporte.creado_por.get_full_name|default:reporte.creado_por.username }}</div>
            </div>
            
            <div class="detail-item">
                <label>Fecha de Creación</label>
                <div class="value">{{ reporte.fecha_creacion|date:"d/m/Y H:i" }}</div>
            </div>
            
            <div class="detail-item">
                <label>Estado</label>
                <div class="value">
                    {% if reporte.generado %}
                        <span class="badge bg-success">Generado</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">Pendiente</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="detail-row">
            <div class="detail-item">
                <label>Fecha de Inicio</label>
                <div class="value">{{ reporte.fecha_inicio|date:"d/m/Y" }}</div>
            </div>
            
            <div class="detail-item">
                <label>Fecha de Fin</label>
                <div class="value">{{ reporte.fecha_fin|date:"d/m/Y" }}</div>
            </div>
            
            <div class="detail-item">
                <label>Archivo</label>
                <div class="value">
                    {% if reporte.archivo %}
                        <a href="{{ reporte.archivo.url }}" class="btn btn-sm btn-success" download>
                            <img src="{% static 'img/icons/download.svg' %}" alt="Descargar" style="width: 16px; height: 16px; filter: invert(1);">
                            Descargar Archivo
                        </a>
                    {% else %}
                        <span style="color: #95a5a6;">No hay archivo adjunto</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% if reporte.descripcion %}
        <div class="detail-item" style="margin-top: 20px;">
            <label>Descripción</label>
            <div class="description-box">
                {{ reporte.descripcion|linebreaks }}
            </div>
        </div>
        {% endif %}
        
        <div class="action-buttons">
            <a href="{% url 'reportes:reporte_list' %}" class="btn btn-secondary">
                Volver al Listado
            </a>
            
            {% if request.user|has_perm:"reportes,exportar" %}
            <div class="btn-group">
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Exportar
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'reportes:reporte_export' reporte.pk 'pdf' %}">
                        Exportar a PDF
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'reportes:reporte_export' reporte.pk 'excel' %}">
                        Exportar a Excel
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'reportes:reporte_export' reporte.pk 'csv' %}">
                        Exportar a CSV
                    </a></li>
                </ul>
            </div>
            {% endif %}
            
            {% if request.user|has_perm:"reportes,generar" %}
            <button type="button" class="btn btn-info" onclick="generarReporte({{ reporte.pk }})">
                Generar Datos
            </button>
            {% endif %}
            
            {% if request.user|has_perm:"reportes,editar" %}
            <a href="{% url 'reportes:reporte_update' reporte.pk %}" class="btn btn-primary">Editar Reporte</a>
            {% endif %}
            
            {% if request.user|has_perm:"reportes,eliminar" %}
            <a href="{% url 'reportes:reporte_delete' reporte.pk %}" class="btn btn-danger">Eliminar Reporte</a>
            {% endif %}
        </div>
    </div>
</div>

<script>
function generarReporte(reporteId) {
    if (confirm('¿Desea generar/actualizar los datos de este reporte?')) {
        fetch(`/reportes/${reporteId}/generar/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Reporte generado exitosamente');
                location.reload();
            } else {
                alert('Error al generar reporte: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error al generar reporte');
            console.error('Error:', error);
        });
    }
}
</script>
{% endblock %}
