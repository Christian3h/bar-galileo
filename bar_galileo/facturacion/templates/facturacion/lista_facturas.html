{% extends 'base_admin.html' %}
{% load static %}
{% load format_tags %}

{% block extra_css%}
  <link rel="stylesheet" href="{% static 'css/main/admin/tables.css' %}">
    <link rel="stylesheet" href="{% static 'css/main/facturacion/facturacion.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h2 class="dashboard-title">Gestión de Facturas</h2>

    <!-- Estadísticas -->
    <section class="dashboard-cards">
        <div class="card">
            <h3>Total Facturas</h3>
            <p>{{ estadisticas.total_facturas }}</p>
        </div>
        <div class="card">
            <h3>Ingresos Totales</h3>
            <p>{{ estadisticas.total_ingresos|format_price }}</p>
        </div>
        <div class="card">
            <h3>Facturas Hoy</h3>
            <p>{{ estadisticas.facturas_hoy }}</p>

        </div>
        <div class="card">
            <h3>Ingresos Hoy</h3>
            <p>{{ estadisticas.ingresos_hoy|format_price }}</p>
        </div>
    </section>

    <!-- Botón de exportar (PDF / Excel) -->
    <div class="export-actions" style="margin: 16px 0;">
        <div class="btn-group">
            <button type="button" class="btn btn-primary">Exportar</button>
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <div class="dropdown-menu">
                <a class="dropdown-item" href="{% url 'facturacion:export_facturas' 'pdf' %}?busqueda={{ busqueda }}&fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}" target="_blank">Exportar PDF</a>
                <a class="dropdown-item" href="{% url 'facturacion:export_facturas' 'csv' %}?busqueda={{ busqueda }}&fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}">Exportar CSV</a>
                <a class="dropdown-item" href="{% url 'facturacion:export_facturas' 'xlsx' %}?busqueda={{ busqueda }}&fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}">Exportar Excel (.xlsx)</a>
            </div>
        </div>
    </div>

    <!-- Filtros de búsqueda -->
    <div class="search-container">
        <form method="GET" class="search-form">
            <div class="search-fields">
                <div class="field-group">
                    <label>Buscar:</label>
                    <input type="text"
                           name="busqueda"
                           value="{{ busqueda }}"
                           placeholder="Número de factura o mesa...">
                </div>
                <div class="field-group">
                    <label>Fecha Inicio:</label>
                    <input type="date"
                           name="fecha_inicio"
                           value="{{ fecha_inicio }}">
                </div>
                <div class="field-group">
                    <label>Fecha Fin:</label>
                    <input type="date"
                           name="fecha_fin"
                           value="{{ fecha_fin }}">
                </div>
            </div>
            <div class="field-group buttons-group">
                <button type="submit" class="btn btn-primary">Buscar</button>
                <a href="{% url 'facturacion:lista_facturas' %}" class="btn btn-secondary">Limpiar</a>
            </div>
        </form>
    </div>

    <!-- Botones de exportación -->
    <div class="export-container mb-3">
        <div class="btn-group" role="group" aria-label="Exportar datos">
            <a href="{% url 'facturacion:exportar_csv' %}?{{ request.GET.urlencode }}" 
               class="btn btn-outline-success">
                <img src="{% static 'img/icons/download.svg' %}" alt="CSV" style="width:16px; height:16px;">
                Exportar CSV
            </a>
            <a href="{% url 'facturacion:exportar_xlsx' %}?{{ request.GET.urlencode }}" 
               class="btn btn-outline-primary">
                <img src="{% static 'img/icons/download.svg' %}" alt="XLSX" style="width:16px; height:16px;">
                Exportar Excel
            </a>
            <a href="{% url 'facturacion:exportar_pdf' %}?{{ request.GET.urlencode }}" 
               class="btn btn-outline-danger">
                <img src="{% static 'img/icons/download.svg' %}" alt="PDF" style="width:16px; height:16px;">
                Exportar PDF
            </a>
        </div>
    </div>

    <!-- Lista de facturas -->
    <div class="table-responsive">
        <table id="tabla-facturas" class="table table-striped table-bordered nowrap">
            <thead>
                <tr>
                    <th class="col-1">Número</th>
                    <th class="col-2">Mesa</th>
                    <th class="col-3">Fecha</th>
                    <th class="col-4">Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for factura in page_obj %}
                <tr>
                    <td class="col-1">#{{ factura.numero }}</td>
                    <td class="col-2">
                        {% if factura.mesa_nombre %}
                            {{ factura.mesa_nombre }}
                        {% else %}
                            <span class="text-muted">Sin mesa</span>
                        {% endif %}
                    </td>
                    <td class="col-3">{{ factura.fecha|date:"d/m/Y H:i" }}</td>
                    <td class="col-4">{{ factura.total|format_price }}</td>
                    <td class="actions-cell">
                                <a href="{% url 'facturacion:detalle_factura' factura.id %}"
                                    class="btn btn-sm btn-primary btn-view"
                                    title="Ver detalles">Ver</a>
                                <a href="{% url 'facturacion:eliminar_factura' factura.id %}"
                                    class="btn btn-sm btn-danger btn-delete"
                                    title="Eliminar factura"
                                    ><img src="{% static 'img/icons/delete.svg' %}" alt="Eliminar"></a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
$(document).ready(function() {
    var sel = '#tabla-facturas';
    if (!document.querySelector(sel)) return;

    if ($.fn.dataTable.isDataTable(sel)) {
        $(sel).DataTable().destroy();
    }

    $(sel).DataTable({
        language: { url: "{% static 'js/DataTables/es-ES.json' %}" },
        responsive: true,
        pageLength: 10,
        lengthChange: true,
        ordering: true,
        columnDefs: [ { targets: '_all', defaultContent: '' } ]
    });
});
</script>


{% endblock %}
