{% load humanize %}
{% load format_tags %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Usuario - Bar Galileo</title>
    <link rel="stylesheet" href="/static/css/panel_usuario_custom.css">
    <style>
.avatar-container {
    margin-bottom: 15px;
}
.profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #A68932;
}
.default-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background-color: #333;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: bold;
    border: 3px solid #A68932;
}
.avatar-management {
    padding: 15px;
    text-align: center;
}
.form-error {
  color: #BF452A;
  background: #262626;
  border: 1px solid #A68932;
  border-radius: 6px;
  padding: 6px 12px;
  margin-top: 6px;
  font-size: 0.95em;
  font-weight: bold;
  box-shadow: 0 0 8px #A68932;
}
.alert-success {
  background: #262626;
  color: #A68932;
  border: 2px solid #A68932;
  border-radius: 12px;
  font-size: 1.1em;
  font-weight: bold;
  box-shadow: 0 0 16px #A68932;
  padding: 18px 32px;
  margin-bottom: 10px;
  opacity: 1;
  animation: fadeInOut 3.5s forwards;
}
.history-table-container {
    padding: 15px;
}
.history-table {
    width: 100%;
    border-collapse: collapse;
    color: #ddd;
}
.history-table th, .history-table td {
    border: 1px solid #444;
    padding: 8px 12px;
    text-align: left;
}
.history-table th {
    background-color: #333;
    color: #A68932;
}
.history-table tbody tr:nth-child(odd) {
    background-color: #2c2c2c;
}
.btn-factura {
    color: #A68932;
    text-decoration: none;
    font-weight: bold;
}
.btn-back {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 10px 15px;
    background-color: #A68932;
    color: #1a1a1a;
    text-decoration: none;
    border-radius: 5px;
    font-weight: bold;
}
@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(-20px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-20px); }
}

/* Styles for menu-btn */
.user-navigation {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 1rem;
  justify-content: center;
}

.menu-btn {
  background: none;
  border: 1px solid #A68932;
  color: #A68932;
  text-align: center;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  cursor: pointer;
  border-radius: 5px;
  transition: background-color 0.2s ease, color 0.2s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
  white-space: nowrap;
}

.menu-btn img {
  width: 20px;
  height: 20px;
  filter: brightness(0) saturate(100%) invert(61%) sepia(48%) saturate(476%) hue-rotate(4deg) brightness(92%) contrast(88%);
}

.menu-btn:hover {
  background-color: #A68932;
  color: #262626;
}

.menu-btn:hover img {
  filter: brightness(0) saturate(100%) invert(13%) sepia(9%) saturate(422%) hue-rotate(314deg) brightness(95%) contrast(91%);
}

</style>
</head>
<body>
    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="alert alert-success">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <script>
// Mostrar/ocultar formularios de edici√≥n
function toggleInfoForm(show) {
  document.getElementById('info-display').style.display = show ? 'none' : '';
  document.getElementById('info-form').style.display = show ? '' : 'none';
}
function toggleEmergenciaForm(show) {
  document.getElementById('emergencia-display').style.display = show ? 'none' : '';
  document.getElementById('emergencia-form').style.display = show ? '' : 'none';
}
        setTimeout(function() {
          document.querySelectorAll('.alert-success').forEach(function(el) {
            el.style.display = 'none';
          });
        }, 3500);
    </script>
    <div class="container">
      <div class="header">
        <div class="avatar-container">
            {% if datos.avatar_url %}
                <img src="{{ datos.avatar_url }}" alt="Avatar" class="profile-avatar">
            {% else %}
                <div class="default-avatar">{{ request.user.username|slice:":1"|upper }}</div>
            {% endif %}
        </div>
        <p> Bienvenido, {{ datos.nombre }}</p>

        <!-- Men√∫ de navegaci√≥n -->
        <nav class="user-navigation">
          <a href="{% url 'core:index' %}" class="menu-btn" title="Ir al inicio"><img src="{% static 'img/icons/home.svg' %}" alt="">Inicio</a>
          <a href="{% url 'account_email' %}" class="menu-btn" title="Gestionar correos electr√≥nicos"><img src="{% static 'img/icons/mail.svg' %}" alt="">Email</a>
          <a href="{% url 'account_change_password' %}" class="menu-btn" title="Cambiar tu contrase√±a"><img src="{% static 'img/icons/lock.svg' %}" alt="">Cambiar Contrase√±a</a>
          <a href="{% url 'socialaccount_connections' %}" class="menu-btn" title="Gestionar conexiones con redes sociales"><img src="{% static 'img/icons/link.svg' %}" alt="">Conexiones</a>
          <a href="{% url 'account_logout' %}" class="menu-btn" title="Cerrar sesi√≥n"><img src="{% static 'img/icons/logout.svg' %}" alt="">Cerrar Sesi√≥n</a>
        </nav>
      </div>
      <div class="dashboard">
        <!-- Cuenta Actual -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon current-bill">üí∞</div>
            <div class="card-title">Cuenta Actual</div>
          </div>
          <div class="bill-amount">${{ datos.cuenta_actual.total|intcomma }}</div>
          <div class="bill-details">
            {% for item in datos.cuenta_actual.items %}
            <div class="bill-item">
              <span>{{ item.nombre }}</span>
              <span>${{ item.precio|intcomma }}</span>
            </div>
            {% endfor %}
            <div class="bill-item">
              <span><span class="status-indicator"></span>Total a Pagar</span>
              <span>${{ datos.cuenta_actual.total|intcomma }}</span>
            </div>
          </div>
        </div>
        <!-- Historial de Consumo -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon monthly-history">üìä</div>
            <div class="card-title">Historial de Consumo</div>
          </div>
          <div class="history-table-container">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Mesa</th>
                  <th>Total Pagado</th>
                  <th>Factura</th>
                </tr>
              </thead>
              <tbody>
                {% for pedido in datos.pedidos_facturados %}
                <tr>
                  <td>{{ pedido.fecha_actualizacion|date:"d/m/Y" }}</td>
                  <td>{{ pedido.mesa.nombre|default:"N/A" }}</td>
                  <td>${{ pedido.total|intcomma }}</td>
                  <td>
                    {% if pedido.factura %}
                    <a href="{% url 'tables:ver_factura' pedido.factura.id %}" class="btn-factura">Ver</a>
                    {% else %}
                    <span>N/A</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" style="text-align: center;">No hay historial de consumo todav√≠a.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <!-- Informaci√≥n Personal -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon user-info">üë§</div>
            <div class="card-title">Mi Informaci√≥n</div>
          </div>
          <div class="avatar-management">
              <form method="post" enctype="multipart/form-data" action="{% url 'users:panel_usuario' %}">
                  {% csrf_token %}
                  <label for="avatar-upload" class="edit-btn">Subir/Cambiar Foto</label>
                  <input id="avatar-upload" type="file" name="avatar" accept="image/*" style="display: none;" onchange="this.form.submit()">
                  {% if datos.avatar_url %}
                      <button type="submit" name="delete_avatar" value="1" class="edit-btn" onclick="return confirm('¬øSeguro que quieres eliminar tu foto de perfil?');">Eliminar Foto</button>
                  {% endif %}
              </form>
          </div>
          <div id="info-display">
            <div class="form-field-col">
              <label class="form-label">Nombre:</label>
              <div class="info-input" style="text-align:left;">{{ datos.nombre }}</div>
            </div>
            <div class="form-field-col">
              <label class="form-label">C√©dula:</label>
              <div class="info-input" style="text-align:left;">{{ datos.cedula }}</div>
            </div>
            <div class="form-field-col">
              <label class="form-label">Tel√©fono:</label>
                  <div class="info-input" style="text-align:left;">{% if datos.telefono %}{% if datos.telefono|slice:":3" == '+57' %}+57 {{ datos.telefono|slice:"3:" }}{% else %}+57 {{ datos.telefono }}{% endif %}{% else %}{{ datos.telefono }}{% endif %}</div>
            </div>
            <div class="form-field-col">
              <label class="form-label">Email:</label>
              <div class="info-input" style="text-align:left;">{{ datos.email }}</div>
            </div>
            <div class="form-field-col">
              <label class="form-label">Direcci√≥n:</label>
              <div class="info-input" style="text-align:left;">{{ datos.direccion }}</div>
            </div>

            <button type="button" class="edit-btn" onclick="toggleInfoForm(true)">Editar</button>
          </div>
          <form id="info-form" method="post" action="{% url 'users:editar_info' %}" class="edit-form" style="display:none;">
            {% csrf_token %}
            <div class="form-field-col">
              <label for="nombre" class="form-label">Nombre:</label>
              <input type="text" id="nombre" name="nombre" value="{{ datos.nombre }}" class="info-input">{% if datos.info_errors.nombre %}<div class="form-error">{{ datos.info_errors.nombre }}</div>{% endif %}
            </div>
            <div class="form-field-col">
              <label for="cedula" class="form-label">C√©dula:</label>
              <input type="number" id="cedula" name="cedula" value="{{ datos.cedula }}" pattern="\d*" inputmode="numeric" title="Solo n√∫meros" maxlength="20" class="info-input">{% if datos.info_errors.cedula %}<div class="form-error">{{ datos.info_errors.cedula }}</div>{% endif %}
            </div>
            <div class="form-field-col">
              <label for="telefono" class="form-label">Tel√©fono:</label>
              <input type="number" id="telefono" name="telefono" value="{% if datos.telefono and datos.telefono|slice:":3" == '+57' %}{{ datos.telefono|slice:"3:" }}{% else %}{{ datos.telefono }}{% endif %}" pattern="\d*" inputmode="numeric" title="Solo n√∫meros" maxlength="20" class="info-input">{% if datos.info_errors.telefono %}<div class="form-error">{{ datos.info_errors.telefono }}</div>{% endif %}
            </div>
            <div class="form-field-col">
              <label for="email" class="form-label">Email:</label>
              <input type="email" id="email" name="email" value="{{ datos.email }}" class="info-input">{% if datos.info_errors.email %}<div class="form-error">{{ datos.info_errors.email }}</div>{% endif %}
            </div>
            <div class="form-field-col">
              <label for="direccion" class="form-label">Direcci√≥n:</label>
              <input type="text" id="direccion" name="direccion" value="{{ datos.direccion }}" class="info-input">
            </div>

            <button type="submit">Guardar Cambios</button>
            <button type="submit" formaction="{% url 'users:borrar_info' %}" onclick="return confirm('¬øSeguro que deseas borrar tu informaci√≥n personal?');">Borrar Informaci√≥n</button>
            <button type="button" onclick="toggleInfoForm(false)">Cancelar</button>
          </form>
        </div>
        <!-- Contacto de Emergencia -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon emergency-contact">üö®</div>
            <div class="card-title">Contacto de Emergencia</div>
          </div>
          <div id="emergencia-display">
            {% if datos.emergencia.nombre or datos.emergencia.telefono %}
              <div class="form-field-col">
                <label class="form-label">Nombre:</label>
                <div class="info-input" style="text-align:left;">{{ datos.emergencia.nombre }}</div>
              </div>
              <div class="form-field-col">
                <label class="form-label">Relaci√≥n:</label>
                <div class="info-input" style="text-align:left;">{{ datos.emergencia.relacion }}</div>
              </div>
              <div class="form-field-col">
                <label class="form-label">Tel√©fono:</label>
                    <div class="info-input" style="text-align:left;">{% if datos.emergencia.telefono %}{% if datos.emergencia.telefono|slice:":3" == '+57' %}+57 {{ datos.emergencia.telefono|slice:"3:" }}{% else %}+57 {{ datos.emergencia.telefono }}{% endif %}{% else %}{{ datos.emergencia.telefono }}{% endif %}</div>
              </div>
              <div class="form-field-col">
                <label class="form-label">Tel√©fono Alternativo:</label>
                    <div class="info-input" style="text-align:left;">{% if datos.emergencia.telefono_alt %}{% if datos.emergencia.telefono_alt|slice:":3" == '+57' %}+57 {{ datos.emergencia.telefono_alt|slice:"3:" }}{% else %}+57 {{ datos.emergencia.telefono_alt }}{% endif %}{% else %}{{ datos.emergencia.telefono_alt }}{% endif %}</div>
              </div>
              <div class="form-field-col">
                <label class="form-label">Tipo de Sangre:</label>
                <div class="info-input" style="text-align:left;">{{ datos.emergencia.sangre }}</div>
              </div>
              <div class="form-field-col">
                <label class="form-label">Alergias:</label>
                <div class="info-input" style="text-align:left;">{{ datos.emergencia.alergias }}</div>
              </div>
              <button type="button" class="edit-btn" onclick="toggleEmergenciaForm(true)">Editar</button>
            {% else %}
              <div class="info-input" style="text-align:center; color:#A68932; margin-bottom:18px;">No hay contacto de emergencia registrado.</div>
              <button type="button" class="edit-btn" onclick="toggleEmergenciaForm(true)">Agregar Contacto</button>
            {% endif %}
          </div>
          <form id="emergencia-form" method="post" action="{% url 'users:editar_emergencia' %}" class="edit-form" style="display:none;">
            {% csrf_token %}
            <div class="form-field-col">
              <label for="emergencia_nombre" class="form-label">Nombre:</label>
              <input type="text" id="emergencia_nombre" name="emergencia_nombre" value="{{ datos.emergencia.nombre }}" class="info-input">{% if datos.emergencia_errors.nombre %}<div class="form-error">{{ datos.emergencia_errors.nombre }}</div>{% endif %}
            </div>
            <div class="form-field-col">
              <label for="emergencia_relacion" class="form-label">Relaci√≥n:</label>
              <input type="text" id="emergencia_relacion" name="emergencia_relacion" value="{{ datos.emergencia.relacion }}" class="info-input">
            </div>
            <div class="form-field-col">
              <label for="emergencia_telefono" class="form-label">Tel√©fono:</label>
              <input type="number" id="emergencia_telefono" name="emergencia_telefono" value="{% if datos.emergencia.telefono and datos.emergencia.telefono|slice:":3" == '+57' %}{{ datos.emergencia.telefono|slice:"3:" }}{% else %}{{ datos.emergencia.telefono }}{% endif %}" pattern="\d*" inputmode="numeric" title="Solo n√∫meros" maxlength="20" class="info-input">{% if datos.emergencia_errors.telefono %}<div class="form-error">{{ datos.emergencia_errors.telefono }}</div>{% endif %}
            </div>
            <div class="form-field-col">
              <label for="emergencia_telefono_alt" class="form-label">Tel√©fono Alternativo:</label>
              <input type="number" id="emergencia_telefono_alt" name="emergencia_telefono_alt" value="{% if datos.emergencia.telefono_alt and datos.emergencia.telefono_alt|slice:":3" == '+57' %}{{ datos.emergencia.telefono_alt|slice:"3:" }}{% else %}{{ datos.emergencia.telefono_alt }}{% endif %}" pattern="\d*" inputmode="numeric" title="Solo n√∫meros" maxlength="20" class="info-input">{% if datos.emergencia_errors.telefono_alt %}<div class="form-error">{{ datos.emergencia_errors.telefono_alt }}</div>{% endif %}
            </div>
            <div class="form-field-col">
              <label for="emergencia_sangre" class="form-label">Tipo de Sangre:</label>
              <select id="emergencia_sangre" name="emergencia_sangre" class="info-input" required>
                <option value="" disabled {% if not datos.emergencia.sangre %}selected{% endif %}>Selecciona el tipo</option>
                <option value="A+" {% if datos.emergencia.sangre == 'A+' %}selected{% endif %}>A+</option>
                <option value="A-" {% if datos.emergencia.sangre == 'A-' %}selected{% endif %}>A-</option>
                <option value="B+" {% if datos.emergencia.sangre == 'B+' %}selected{% endif %}>B+</option>
                <option value="B-" {% if datos.emergencia.sangre == 'B-' %}selected{% endif %}>B-</option>
                <option value="AB+" {% if datos.emergencia.sangre == 'AB+' %}selected{% endif %}>AB+</option>
                <option value="AB-" {% if datos.emergencia.sangre == 'AB-' %}selected{% endif %}>AB-</option>
                <option value="O+" {% if datos.emergencia.sangre == 'O+' %}selected{% endif %}>O+</option>
                <option value="O-" {% if datos.emergencia.sangre == 'O-' %}selected{% endif %}>O-</option>
              </select>
            </div>
            <div class="form-field-col">
              <label for="emergencia_alergias" class="form-label">Alergias:</label>
              <input type="text" id="emergencia_alergias" name="emergencia_alergias" value="{{ datos.emergencia.alergias }}" class="info-input">
            </div>
            <button type="submit">Guardar Cambios</button>
            <button type="submit" formaction="{% url 'users:borrar_emergencia' %}" onclick="return confirm('¬øSeguro que deseas borrar el contacto de emergencia?');">Borrar Contacto</button>
            <button type="button" onclick="toggleEmergenciaForm(false)">Cancelar</button>
          </form>
        </div>
      </div>
    </div>

  <script>
function validarInfoForm() {
  let nombre = document.querySelector('input[name="nombre"]').value.trim();
  let cedula = document.querySelector('input[name="cedula"]').value.trim();
  let telefono = document.querySelector('input[name="telefono"]').value.trim();
  let email = document.querySelector('input[name="email"]').value.trim();
  let errores = [];
  if (nombre.length < 3) errores.push('El nombre debe tener al menos 3 caracteres.');
  if (!/^\d{6,}$/.test(cedula)) errores.push('La c√©dula debe ser num√©rica y tener al menos 6 d√≠gitos.');
  if (!/^\d{10}$/.test(telefono)) errores.push('El tel√©fono debe ser num√©rico y tener exactamente 10 d√≠gitos.');
  if (!email.includes('@')) errores.push('El email debe ser v√°lido.');
  if (errores.length) {
    alert(errores.join('\n'));
    return false;
  }
  return true;
}
function validarEmergenciaForm() {
  let nombre = document.querySelector('input[name="emergencia_nombre"]').value.trim();
  let telefono = document.querySelector('input[name="emergencia_telefono"]').value.trim();
  let telefono_alt = document.querySelector('input[name="emergencia_telefono_alt"]').value.trim();
  let errores = [];
  if (nombre.length < 3) errores.push('El nombre de emergencia debe tener al menos 3 caracteres.');
  if (telefono && !/^\d{10}$/.test(telefono)) errores.push('El tel√©fono debe ser num√©rico y tener exactamente 10 d√≠gitos.');
  if (telefono_alt && !/^\d{10}$/.test(telefono_alt)) errores.push('El tel√©fono alternativo debe ser num√©rico y tener exactamente 10 d√≠gitos.');
  if (errores.length) {
    alert(errores.join('\n'));
    return false;
  }
  return true;
}
document.addEventListener('DOMContentLoaded', function() {
  var infoForm = document.getElementById('info-form');
  if (infoForm) infoForm.onsubmit = validarInfoForm;
  var emergenciaForm = document.getElementById('emergencia-form');
  if (emergenciaForm) emergenciaForm.onsubmit = validarEmergenciaForm;
});
  </script>
  <script>
document.addEventListener('DOMContentLoaded', function() {
    const protocol = window.location.protocol === 'https' ? 'wss' : 'ws';
    const ws = new WebSocket(`${protocol}://${window.location.host}/ws/panel/`);

    ws.onopen = function() {
        console.log("WebSocket connection for panel established.");
    };

    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.cuenta_actual) {
            updateCuentaActual(data.cuenta_actual);
        }
    };

    ws.onclose = function() {
        console.log("WebSocket connection for panel closed.");
    };

    ws.onerror = function(error) {
        console.error("WebSocket error:", error);
    };

    function formatPrice(number) {
        return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(number);
    }

    function updateCuentaActual(cuenta) {
        const billAmount = document.querySelector('.bill-amount');
        const billDetails = document.querySelector('.bill-details');

        if (billAmount) {
            billAmount.textContent = formatPrice(cuenta.total);
        }

        if (billDetails) {
            let itemsHtml = '';
            if (cuenta.items && cuenta.items.length > 0) {
                cuenta.items.forEach(item => {
                    itemsHtml += `
                        <div class="bill-item">
                            <span>${item.nombre}</span>
                            <span>${formatPrice(item.precio)}</span>
                        </div>
                    `;
                });
            }

            itemsHtml += `
                <div class="bill-item">
                    <span><span class="status-indicator"></span>Total a Pagar</span>
                    <span>${formatPrice(cuenta.total)}</span>
                </div>
            `;
            billDetails.innerHTML = itemsHtml;
        }
    }
});
  </script>
  <script src="{% static 'accessibility/sienna.js' %}"></script>
  <script src="{% static 'accessibility/custom.js' %}"></script>

</body>
</html>