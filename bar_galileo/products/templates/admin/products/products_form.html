{% extends 'base_admin.html' %}
{% load static %}

{% block extra_css %}
<style>
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    .image-container {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s ease, opacity 0.3s ease;
        border: 1px solid #ddd;
    }
    .image-container img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
    }
    .image-container.deleted {
        transform: scale(0.9);
        opacity: 0.4;
    }
    .image-container.deleted::after {
        content: 'Eliminada';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-weight: bold;
    }
    .image-actions {
        position: absolute;
        top: 5px;
        right: 5px;
        display: flex;
        gap: 5px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .image-container:hover .image-actions {
        opacity: 1;
    }
    .image-actions .btn {
        padding: 0.25rem 0.5rem;
        font-size: 12px;
    }
    /* Estilos para el modal de maximizar imagen */
    .modal-image-viewer {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1050; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
    }
    .modal-image-viewer-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .close-modal-image-viewer {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<h1>{% if object %}Editar{% else %}Crear{% endif %} Producto</h1>

<a href="{% url 'products:products_admin' %}" class="btn btn-secondary">Volver</a>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}

    <div class="form-group">
        <label for="id_imagenes">A√±adir nuevas im√°genes:</label>
        <input type="file" name="imagenes" id="id_imagenes" multiple class="form-control-file">
    </div>

    {% if object.imagenes.all %}
        <h4>Im√°genes actuales</h4>
        <div class="image-grid" id="image-grid">
            {% for imagen in object.imagenes.all %}
                <div class="image-container" id="image-container-{{ imagen.id_imagen }}">
                    <img src="{% static imagen.imagen %}" class="img-thumbnail">
                    <div class="image-actions">
                        <button type="button" class="btn btn-sm btn-info maximize-image-btn" data-src="{% static imagen.imagen %}">üîç</button>
                        <button type="button" class="btn btn-sm btn-danger delete-image-btn" data-id="{{ imagen.id_imagen }}" data-delete-url="{% url 'products:producto_imagen_eliminar_api' imagen.id_imagen %}">üóëÔ∏è</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="form-actions mt-3">
        <button type="submit" class="btn btn-primary">{% if object %}Actualizar{% else %}Crear{% endif %} Producto</button>
    </div>
</form>

<!-- Modal para maximizar imagen -->
<div id="imageViewerModal" class="modal-image-viewer">
    <span class="close-modal-image-viewer">&times;</span>
    <img class="modal-image-viewer-content" id="viewerModalImage">
</div>

<!-- Modal para mensajes de error/√©xito -->
{% include 'components/simple_modal.html' %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageGrid = document.getElementById('image-grid');
    
    // Elementos del modal de maximizar imagen
    const imageViewerModal = document.getElementById('imageViewerModal');
    const viewerModalImage = document.getElementById('viewerModalImage');
    const closeImageViewerModal = document.querySelector('.close-modal-image-viewer');

    // Elementos del modal de mensajes
    const simpleModal = document.getElementById('simpleModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalFooter = simpleModal.querySelector('.modal-footer');
    const closeModalButtons = simpleModal.querySelectorAll('.close-modal');

    // Funci√≥n para mostrar el modal de mensajes
    function showSimpleModal(title, message, isConfirm = false, onConfirm = null) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalFooter.innerHTML = ''; // Limpiar botones anteriores

        if (isConfirm) {
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'S√≠, Eliminar';
            confirmBtn.classList.add('btn', 'btn-danger', 'mt-3');
            confirmBtn.onclick = function() {
                simpleModal.style.display = 'none';
                if (onConfirm) onConfirm();
            };
            modalFooter.appendChild(confirmBtn);

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.classList.add('btn', 'btn-secondary', 'mt-3', 'ms-2');
            cancelBtn.onclick = function() {
                simpleModal.style.display = 'none';
            };
            modalFooter.appendChild(cancelBtn);
        } else {
            const okBtn = document.createElement('button');
            okBtn.textContent = 'Aceptar';
            okBtn.classList.add('btn', 'btn-primary', 'mt-3');
            okBtn.onclick = function() {
                simpleModal.style.display = 'none';
            };
            modalFooter.appendChild(okBtn);
        }
        simpleModal.style.display = 'block';
    }

    // Event listeners para cerrar el modal de mensajes
    closeModalButtons.forEach(button => {
        button.addEventListener('click', function() {
            simpleModal.style.display = 'none';
        });
    });
    window.addEventListener('click', function(event) {
        if (event.target == simpleModal) {
            simpleModal.style.display = 'none';
        }
    });

    if (imageGrid) {
        imageGrid.addEventListener('click', function(event) {
            const target = event.target.closest('button'); 

            if (!target) return; 

            // --- Manejar clic en el bot√≥n de eliminar ---
            if (target.classList.contains('delete-image-btn')) {
                const imageId = target.dataset.id;
                const deleteUrl = target.dataset.deleteUrl; // Obtener la URL del atributo data-delete-url
                const imageContainer = document.getElementById(`image-container-${imageId}`);

                showSimpleModal(
                    'Confirmar Eliminaci√≥n',
                    '¬øEst√°s seguro de que quieres eliminar esta imagen?',
                    true, // Es un modal de confirmaci√≥n
                    function() { // Callback para cuando se confirma la eliminaci√≥n
                        fetch(deleteUrl, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => {
                                    throw new Error(err.error || `Error del servidor: ${response.statusText}`);
                                }).catch(() => {
                                    throw new Error(`Error del servidor: ${response.statusText}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                imageContainer.classList.add('deleted');
                                showSimpleModal('√âxito', 'Imagen eliminada correctamente.');
                            } else {
                                showSimpleModal('Error', data.error || 'Error al eliminar la imagen.');
                            }
                        })
                        .catch(error => {
                            showSimpleModal('Error de Conexi√≥n', error.message || 'Error de conexi√≥n al eliminar la imagen.');
                        });
                    }
                );
            }

            // --- Manejar clic en el bot√≥n de maximizar ---
            if (target.classList.contains('maximize-image-btn')) {
                const imgSrc = target.dataset.src;
                imageViewerModal.style.display = "block";
                viewerModalImage.src = imgSrc;
            }
        });
    }

    // --- Cerrar el modal de maximizar imagen ---
    if(closeImageViewerModal) {
        closeImageViewerModal.addEventListener('click', function() {
            imageViewerModal.style.display = "none";
        });
    }

    if(imageViewerModal) {
        window.addEventListener('click', function(event) {
            if (event.target == imageViewerModal) {
                imageViewerModal.style.display = "none";
            }
        });
    }
});
</script>
{% endblock %}